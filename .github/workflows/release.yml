name: Release Plugin

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Prepare and Zip Plugin
        run: |
          # Extract version from tag (e.g., v2.2.6 -> 2.2.6)
          VERSION=${GITHUB_REF_NAME#v}
          ZIP_NAME="SDBanana_${VERSION}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

          # Create staging directory structure (SDBanana/SDBanana/ for code)
          mkdir -p build_staging/SDBanana/SDBanana

          # Copy plugin code to nested SDBanana/SDBanana/
          cp -r SDBanana/* build_staging/SDBanana/SDBanana/

          # Copy root-level files to outer SDBanana/
          cp pluginInfo.json build_staging/SDBanana/
          cp README.md build_staging/SDBanana/ 2>/dev/null || true
          cp LICENSE build_staging/SDBanana/ 2>/dev/null || true

          # Zip the folder
          cd build_staging
          zip -r "../$ZIP_NAME" SDBanana
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
